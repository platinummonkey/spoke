name: Spoke Schema Push

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
    paths:
      - 'proto/**/*.proto'
      - 'schemas/**/*.proto'

jobs:
  push:
    name: Push Schemas to Spoke Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for versioning

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: '25.x'
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Spoke CLI
        run: |
          curl -sSL https://github.com/platinummonkey/spoke/releases/latest/download/spoke-cli-linux-amd64 -o /usr/local/bin/spoke
          chmod +x /usr/local/bin/spoke
          spoke --version

      - name: Determine version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git describe --tags --always --dirty)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Push schemas to registry
        env:
          SPOKE_REGISTRY_URL: ${{ secrets.SPOKE_REGISTRY_URL }}
          SPOKE_API_TOKEN: ${{ secrets.SPOKE_API_TOKEN }}
        run: |
          # Configure Spoke CLI
          spoke config set registry "$SPOKE_REGISTRY_URL"
          spoke config set token "$SPOKE_API_TOKEN"

          # Determine module name (from repo)
          MODULE_NAME="${GITHUB_REPOSITORY}"

          # Push schemas
          spoke push \
            --module "$MODULE_NAME" \
            --version "${{ steps.version.outputs.version }}" \
            --dir proto \
            --description "Automated push from GitHub Actions" \
            --check-compatibility

      - name: Generate summary
        if: always()
        run: |
          echo "## Spoke Schema Push" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Module**: $GITHUB_REPOSITORY" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            core.setFailed('Schema push to Spoke registry failed')
