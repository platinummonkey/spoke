# Spoke Schema Validation Template for GitLab CI
# Include this template in your .gitlab-ci.yml:
#
# include:
#   - remote: 'https://raw.githubusercontent.com/platinummonkey/spoke/main/.gitlab-ci-templates/spoke-validate.yml'
#
# Or copy this file to your project

.spoke_setup:
  before_script:
    - |
      # Install Spoke CLI
      curl -sSL https://github.com/platinummonkey/spoke/releases/latest/download/spoke-cli-linux-amd64 -o /usr/local/bin/spoke
      chmod +x /usr/local/bin/spoke
      spoke --version

spoke:validate:
  extends: .spoke_setup
  stage: test
  image: alpine:latest
  script:
    - apk add --no-cache git curl
    - |
      # Validate all proto files
      find proto schemas -name "*.proto" 2>/dev/null || true | while read file; do
        echo "Validating $file"
        spoke validate "$file" --strict
      done
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - proto/**/*.proto
        - schemas/**/*.proto
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - proto/**/*.proto
        - schemas/**/*.proto

spoke:check_compatibility:
  extends: .spoke_setup
  stage: test
  image: alpine:latest
  script:
    - apk add --no-cache git curl
    - |
      # Fetch base branch
      git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME

      # Check each changed proto file
      git diff --name-only origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...HEAD | grep '\.proto$' || exit 0

      git diff --name-only origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...HEAD | grep '\.proto$' | while read file; do
        if [ -f "$file" ]; then
          echo "Checking $file for breaking changes"

          # Get old version
          git show origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME:$file > /tmp/old.proto

          # Compare
          spoke check-compatibility \
            --old /tmp/old.proto \
            --new "$file" \
            --mode BACKWARD \
            --verbose || exit 1
        fi
      done
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - proto/**/*.proto
        - schemas/**/*.proto
  allow_failure: false

spoke:lint:
  extends: .spoke_setup
  stage: test
  image: alpine:latest
  script:
    - apk add --no-cache git curl
    - |
      # Lint all proto files
      find proto schemas -name "*.proto" 2>/dev/null || true | while read file; do
        echo "Linting $file"
        spoke lint "$file" --config .spoke-lint.yml || true
      done
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - proto/**/*.proto
        - schemas/**/*.proto
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - proto/**/*.proto
        - schemas/**/*.proto
  allow_failure: true

spoke:push:
  extends: .spoke_setup
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache git curl
    - |
      # Determine version
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION=$CI_COMMIT_TAG
      else
        VERSION=$(git describe --tags --always --dirty)
      fi

      echo "Pushing version $VERSION"

      # Configure Spoke CLI
      spoke config set registry "$SPOKE_REGISTRY_URL"
      spoke config set token "$SPOKE_API_TOKEN"

      # Push schemas
      spoke push \
        --module "$CI_PROJECT_PATH" \
        --version "$VERSION" \
        --dir proto \
        --description "Automated push from GitLab CI" \
        --check-compatibility
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - proto/**/*.proto
        - schemas/**/*.proto
    - if: '$CI_COMMIT_TAG'
  variables:
    SPOKE_REGISTRY_URL: $SPOKE_REGISTRY_URL
    SPOKE_API_TOKEN: $SPOKE_API_TOKEN
