# Plugin Manifest Specification

## Overview

Every Spoke plugin must include a `plugin.yaml` manifest file that describes the plugin's metadata, capabilities, and requirements. This document specifies the format and fields of the plugin manifest.

## Manifest Format

The manifest is a YAML file named `plugin.yaml` located in the plugin's root directory.

## Required Fields

### `id` (string)
Unique identifier for the plugin. Must be lowercase with hyphens (kebab-case).

**Example:** `rust-language`, `buf-connect-go`, `protolint-validator`

### `name` (string)
Human-readable name of the plugin.

**Example:** `Rust Language Plugin`, `Buf Connect for Go`, `Protolint Validator`

### `version` (string)
Plugin version following semantic versioning (semver).

**Format:** `MAJOR.MINOR.PATCH` or `vMAJOR.MINOR.PATCH`

**Example:** `1.0.0`, `v2.1.3`, `0.5.0-beta.1`

### `api_version` (string)
Version of the Spoke Plugin SDK API this plugin uses. Must follow semver.

**Current SDK Version:** `1.0.0`

**Example:** `1.0.0`

### `type` (string)
Category of plugin. Must be one of:
- `language` - Code generation for programming languages
- `validator` - Schema validation and linting
- `generator` - Package/documentation generation
- `runner` - Custom execution environments
- `transform` - Code transformations

**Example:** `language`

## Optional Fields

### `description` (string)
Short description of the plugin's functionality.

**Example:** `Protocol Buffers code generation for Rust using prost`

### `author` (string)
Name of the plugin author or organization.

**Example:** `Spoke Community`, `Jane Doe`, `Acme Corp`

### `license` (string)
Software license for the plugin.

**Example:** `MIT`, `Apache-2.0`, `BSD-3-Clause`

### `homepage` (string)
URL to the plugin's homepage or documentation.

**Example:** `https://plugins.spoke.dev/rust`

### `repository` (string)
URL to the plugin's source code repository.

**Example:** `https://github.com/spoke-plugins/rust-language`

### `security_level` (string)
Trust level of the plugin. One of:
- `official` - Built by Spoke team
- `verified` - Community plugin, code reviewed, security approved
- `community` - Unverified community plugin

**Default:** `community`

**Example:** `verified`

### `permissions` (array of strings)
List of permissions required by the plugin. Available permissions:
- `filesystem:read` - Read files from disk
- `filesystem:write` - Write files to disk
- `network:read` - Make network requests
- `network:write` - Accept network connections
- `process:exec` - Execute external processes
- `env:read` - Read environment variables

**Example:**
```yaml
permissions:
  - filesystem:read
  - filesystem:write
  - process:exec
```

### `dependencies` (array of strings)
List of other plugin IDs that this plugin depends on.

**Example:**
```yaml
dependencies:
  - common-types
  - base-validator
```

### `metadata` (map of string to string)
Additional plugin-specific metadata as key-value pairs.

**Example:**
```yaml
metadata:
  language_family: rust
  supports_wasm: "true"
  min_protoc_version: "3.15.0"
```

## Language Plugin Fields

Language plugins should include a `language_spec` section or a separate `language_spec.yaml` file.

### `language_spec.id` (string)
Unique identifier for the language (used in protoc flags).

**Example:** `rust`, `go`, `python`

### `language_spec.name` (string)
Short name of the language.

**Example:** `Rust`, `Go`, `Python`

### `language_spec.display_name` (string)
Full display name including variants.

**Example:** `Rust (prost + tonic)`, `Python (protobuf 3.x)`

### `language_spec.supports_grpc` (boolean)
Whether this language plugin supports gRPC code generation.

**Default:** `false`

### `language_spec.file_extensions` (array of strings)
List of file extensions generated by this plugin.

**Example:** `[".rs"]`, `[".go"]`, `[".py"]`

### `language_spec.enabled` (boolean)
Whether the language is enabled by default.

**Default:** `true`

### `language_spec.stable` (boolean)
Whether the language support is production-ready.

**Default:** `false`

### `language_spec.protoc_plugin` (string)
Name of the protoc plugin binary (without `protoc-gen-` prefix).

**Example:** `prost`, `go`, `python`

### `language_spec.docker_image` (string)
Docker image containing protoc and the plugin (optional).

**Example:** `spoke/rust-protoc:1.2`, `bufbuild/buf:latest`

### `language_spec.package_manager` (object)
Package manager configuration for generated code.

**Fields:**
- `name` (string) - Package manager name (`cargo`, `npm`, `pip`, etc.)
- `config_files` (array) - Config files to generate (`Cargo.toml`, `package.json`, etc.)
- `dependency_map` (map) - Mapping of generic dependencies to language-specific packages
- `default_versions` (map) - Default versions for dependencies

## Example Manifests

### Language Plugin Example

```yaml
id: rust-language
name: Rust Language Plugin
version: 1.2.0
api_version: 1.0.0
description: Protocol Buffers code generation for Rust using prost
author: Spoke Community
license: MIT
homepage: https://plugins.spoke.dev/rust
repository: https://github.com/spoke-plugins/rust-language
type: language
security_level: verified
permissions:
  - filesystem:read
  - filesystem:write
  - process:exec

language_spec:
  id: rust
  name: Rust
  display_name: Rust (prost + tonic)
  supports_grpc: true
  file_extensions: [".rs"]
  enabled: true
  stable: true
  description: Rust language support with prost and tonic
  documentation_url: https://github.com/tokio-rs/prost
  plugin_version: "0.11.0"
  protoc_plugin: "protoc-gen-prost"
  docker_image: "spoke/rust-protoc:1.2"

  package_manager:
    name: cargo
    config_files: ["Cargo.toml", "README.md"]
    dependency_map:
      protobuf: prost
      grpc: tonic
    default_versions:
      prost: "0.11"
      tonic: "0.9"
```

### Validator Plugin Example

```yaml
id: protolint-validator
name: Protolint Validator
version: 0.42.0
api_version: 1.0.0
description: Lints Protocol Buffer files for style violations
author: Yuki Yugui Sonoda
license: MIT
homepage: https://github.com/yoheimuta/protolint
repository: https://github.com/yoheimuta/protolint
type: validator
security_level: verified
permissions:
  - filesystem:read

metadata:
  lint_rules: "google,uber"
  auto_fix: "true"
```

### Buf Plugin Example

```yaml
id: buf-connect-go
name: Buf Connect for Go
version: 1.5.0
api_version: 1.0.0
description: Connect RPC framework for Go (Buf plugin)
author: Buf Technologies
license: Apache-2.0
homepage: https://buf.build/library/connect-go
repository: https://github.com/bufbuild/connect-go
type: language
security_level: verified
buf_plugin:
  registry: buf.build/library/connect-go
  version: v1.5.0

language_spec:
  id: connect-go
  name: Connect (Go)
  display_name: Connect RPC for Go
  supports_grpc: true
  file_extensions: [".connect.go"]
  enabled: true
  stable: true
```

## Validation Rules

1. **Required fields must be present:** `id`, `name`, `version`, `api_version`, `type`
2. **Versions must follow semver:** Both `version` and `api_version`
3. **Plugin ID must be kebab-case:** lowercase with hyphens only
4. **Type must be valid:** One of the predefined plugin types
5. **Security level must be valid:** `official`, `verified`, or `community`
6. **Permissions must be recognized:** Only allowed permissions
7. **Dependencies must exist:** Referenced plugin IDs must be valid

## API Versioning

### Compatibility Policy

- **Major version (v1.0.0 → v2.0.0):** Breaking changes, incompatible interface changes
- **Minor version (v1.0.0 → v1.1.0):** New features, backward compatible
- **Patch version (v1.0.0 → v1.0.1):** Bug fixes only

### Version Check

Spoke checks plugin `api_version` against the SDK version:
- Same major version → Compatible
- Different major version → Incompatible, plugin rejected

**Example:**
- Plugin `api_version: 1.2.0` works with SDK `1.0.0` ✅
- Plugin `api_version: 2.0.0` fails with SDK `1.5.0` ❌

## Best Practices

1. **Use semantic versioning consistently** - Follow semver strictly for both plugin and API versions
2. **Request minimal permissions** - Only request permissions your plugin actually uses
3. **Provide clear descriptions** - Help users understand what your plugin does
4. **Include repository links** - Allow users to inspect source code
5. **Document breaking changes** - Increment major version when breaking compatibility
6. **Test before publishing** - Validate manifest and test plugin functionality
7. **Keep metadata up to date** - Update version, description, dependencies as plugin evolves

## Validation Commands

Validate a plugin manifest:
```bash
spoke plugin validate ./my-plugin/
```

Check compatibility:
```bash
spoke plugin check-compatibility ./my-plugin/
```

Lint manifest:
```bash
spoke plugin lint ./my-plugin/plugin.yaml
```

## See Also

- [Plugin Development Guide](PLUGIN_DEVELOPMENT.md)
- [Plugin API Reference](PLUGIN_API.md)
- [Language Plugin Tutorial](tutorials/language-plugin.md)
- [Security Guidelines](SECURITY.md)
