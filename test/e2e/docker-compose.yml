version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    pull_policy: missing
    container_name: spoke-postgres-test
    environment:
      POSTGRES_PASSWORD: spoke
      POSTGRES_USER: spoke
      POSTGRES_DB: spoke
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../../migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U spoke -d spoke"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - spoke-network

  # Redis Cache
  redis:
    image: redis:7-alpine
    pull_policy: missing
    container_name: spoke-redis-test
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - spoke-network

  # MinIO (S3-compatible storage)
  minio:
    image: minio/minio:latest
    pull_policy: missing
    container_name: spoke-minio-test
    environment:
      MINIO_ROOT_USER: spoke
      MINIO_ROOT_PASSWORD: spokespoke
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - spoke-network

  # Spoke API Server
  spoke-api:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.spoke
      pull_policy: missing
    container_name: spoke-api-test
    environment:
      DATABASE_URL: "postgres://spoke:spoke@postgres:5432/spoke?sslmode=disable"
      REDIS_URL: "redis:6379"
      S3_ENDPOINT: "http://minio:9000"
      S3_ACCESS_KEY: "spoke"
      S3_SECRET_KEY: "spokespoke"
      S3_BUCKET: "spoke-plugins"
      PORT: "8080"
      LOG_LEVEL: "debug"
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - spoke-network

  # Sprocket Compilation Service
  sprocket:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.sprocket
      pull_policy: missing
    container_name: spoke-sprocket-test
    environment:
      DATABASE_URL: "postgres://spoke:spoke@postgres:5432/spoke?sslmode=disable"
      REDIS_URL: "redis:6379"
      STORAGE_DIR: "/var/spoke/storage"
      PLUGIN_DIRS: "/etc/spoke/plugins:/root/.spoke/plugins"
      LOG_LEVEL: "debug"
      POLL_DELAY: "10s"
    volumes:
      - spoke_storage:/var/spoke/storage
      - ./test-plugins:/etc/spoke/plugins:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - spoke-network

  # Plugin Verifier Service
  plugin-verifier:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.verifier
      pull_policy: missing
    container_name: spoke-verifier-test
    environment:
      DATABASE_URL: "postgres://spoke:spoke@postgres:5432/spoke?sslmode=disable"
      POLL_INTERVAL: "30s"
      MAX_CONCURRENT: "3"
      LOG_LEVEL: "debug"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - spoke-network

  # Web UI
  spoke-web:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.web
      pull_policy: missing
    container_name: spoke-web-test
    environment:
      VITE_API_URL: "http://localhost:8080"
    ports:
      - "5173:5173"
    depends_on:
      - spoke-api
    networks:
      - spoke-network

  # Playwright E2E Tests
  playwright:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.playwright
      pull_policy: missing
    container_name: spoke-playwright-test
    environment:
      BASE_URL: "http://spoke-web:5173"
      API_URL: "http://spoke-api:8080"
    volumes:
      - ./playwright-results:/app/test-results
      - ./playwright-report:/app/playwright-report
    depends_on:
      - spoke-web
      - spoke-api
    networks:
      - spoke-network
    profiles:
      - test

volumes:
  postgres_data:
  minio_data:
  spoke_storage:

networks:
  spoke-network:
    driver: bridge
